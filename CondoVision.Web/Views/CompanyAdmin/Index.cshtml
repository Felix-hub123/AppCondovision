@model CondoVision.Models.DashBoardViewModel
@using System.Text.Json

<section class="content">
    <div class="container-fluid">

        <!-- Linha 1: Cards Resumo -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@Model.CompaniesCount</h3>
                        <p>Total de Empresas</p>
                    </div>
                    <div class="icon"><i class="fas fa-building"></i></div>
                    <a href="/Companies" class="small-box-footer">Mais detalhes <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>@Model.UsersCount</h3>
                        <p>Total de Utilizadores</p>
                    </div>
                    <div class="icon"><i class="fas fa-user"></i></div>
                    <a href="/Users" class="small-box-footer">Mais detalhes <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3>@Model.CondominiumsCount</h3>
                        <p>Total de Condomínios</p>
                    </div>
                    <div class="icon"><i class="fas fa-home"></i></div>
                    <a href="/Condominiums" class="small-box-footer">Mais detalhes <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>@Model.PendingInvoicesCount</h3>
                        <p>Faturas Pendentes</p>
                    </div>
                    <div class="icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <a href="#" class="small-box-footer">Mais detalhes <i class="fas fa-arrow-circle-right"></i></a>
                </div>
            </div>
        </div>

        <!-- Linha 2: Administração e Gráfico -->
        <div class="row">
            <div class="col-md-6">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Opções de Administração</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <a href="/Companies" class="btn btn-primary btn-block mb-2"><i class="fas fa-building"></i> Empresas</a>
                                <a href="/Users" class="btn btn-primary btn-block mb-2"><i class="fas fa-user"></i> Utilizadores</a>
                            </div>
                            <div class="col-md-6">
                                <a href="/Condominiums" class="btn btn-primary btn-block mb-2"><i class="fas fa-home"></i> Condomínios</a>
                                <a href="/Units" class="btn btn-primary btn-block mb-2"><i class="fas fa-key"></i> Unidades</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title">Visão Geral dos Dados</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="myBarChart" style="height:250px; min-height:250px"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Linha 3: Gráfico Unidades e Últimas Atividades -->
        <div class="row">
            <div class="col-md-6">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title">Unidades por Condomínio</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="myLineChart" style="height:250px; min-height:250px"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card card-outline card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Últimas Atividades</h3>
                    </div>
                    <div class="card-body table-responsive p-0" style="max-height:250px; overflow-y:auto;">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr>
                                    <th>📌 ID</th>
                                    <th>👤 Utilizador</th>
                                    <th>⚡ Ação</th>
                                    <th>📅 Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var activity in Model.RecentActivities)
                                {
                                    var badgeClass = activity.Action?.Contains("Criou") == true ? "badge-success" :
                                    activity.Action?.Contains("Atualizou") == true ? "badge-primary" :
                                    activity.Action?.Contains("Eliminou") == true ? "badge-danger" : "badge-secondary";
                                    <tr>
                                        <td>@activity.Id</td>
                                        <td>@activity.UserName</td>
                                        <td><span class="badge @badgeClass">@activity.Action</span></td>
                                        <td>@activity.Date.ToString("dd MMM yyyy, HH:mm")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

@section Scripts {
    <script src="~/AdminLTE/plugins/chart.js/Chart.min.js" asp-append-version="true"></script>
    <script>
        $(function () {
            // Serializar em camelCase para JS
            var dashboardData = @Html.Raw(JsonSerializer.Serialize(Model, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }));

            // Gráfico de Barras
            var ctxBar = document.getElementById('myBarChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Empresas', 'Utilizadores', 'Condomínios'],
                    datasets: [{
                        label: 'Quantidade',
                        data: [
                            dashboardData.companiesCount,
                            dashboardData.usersCount,
                            dashboardData.condominiumsCount
                        ],
                        backgroundColor: ['rgba(23,162,184,0.7)','rgba(40,167,69,0.7)','rgba(255,193,7,0.7)'],
                        borderColor: ['rgba(23,162,184,1)','rgba(40,167,69,1)','rgba(255,193,7,1)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            // Gráfico Linhas Unidades
            var ctxLine = document.getElementById('myLineChart').getContext('2d');
            new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: dashboardData.unitCondominiumIds.map(id => id ?? 'N/A'),
                    datasets: [{
                        label: 'Unidades por Condomínio',
                        data: dashboardData.unitCounts.map(c => c ?? 0),
                        backgroundColor: 'rgba(54,162,235,0.2)',
                        borderColor: 'rgba(54,162,235,1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointStyle: 'circle',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Número de Unidades' } },
                        x: { title: { display: true, text: 'Condomínios' } }
                    }
                }
            });
        });
    </script>
}

